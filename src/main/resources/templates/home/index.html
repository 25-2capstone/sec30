<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
  <title>í™ˆ - Sec30 Music</title>
</head>
<body>
  <div layout:fragment="content">
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-card">
        <h1>Discover Weekly</h1>
        <p>ë‹¹ì‹ ë§Œì„ ìœ„í•œ ìƒˆë¡œìš´ ìŒì•… ë°œê²¬</p>
        <button class="play-btn" onclick="window.location.href='/tracks'">ì§€ê¸ˆ ë“£ê¸°</button>
      </div>
    </section>

    <!-- ì¸ê¸° íŠ¸ë™ ì„¹ì…˜ -->
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title">ì˜¤ëŠ˜ì˜ ì¸ê¸° íŠ¸ë™</h2>
        <a href="/tracks" class="section-link">ëª¨ë‘ ë³´ê¸° â†’</a>
      </div>

      <div class="track-grid" th:if="${tracks != null and !tracks.isEmpty()}">
        <div class="track-card" th:each="track : ${tracks}">
          <div class="track-card-image">
            <img th:src="${track.albumImage}"
                 th:alt="${track.name}"
                 onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
            <button class="track-card-play"
                    th:attr="data-preview=${track.previewUrl != null ? track.previewUrl : ''},
                             data-spotify-id=${track.spotifyId},
                             data-track-name=${track.name}"
                    onclick="playTrack(this)"></button>
          </div>
          <div class="track-card-title" th:text="${track.name}">Track Name</div>
          <div class="track-card-artist" th:text="${track.artist}">Artist</div>
        </div>
      </div>

      <div class="empty-state" th:if="${tracks == null or tracks.isEmpty()}">
        <div class="empty-state-icon">ğŸµ</div>
        <div class="empty-state-title">íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-state-desc">ìŒì•…ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”</div>
      </div>
    </section>

    <!-- ì¶”ì²œ ë¯¹ìŠ¤ ì„¹ì…˜ -->
    <section class="recommended" th:if="${mixes != null and !mixes.isEmpty()}">
      <h2>íšŒì›ë‹˜ì„ ìœ„í•œ ë§ì¶¤ ë¯¹ìŠ¤</h2>
      <div class="cards">
        <div class="card" th:each="mix : ${mixes}">
          <img th:src="${mix.imageUrl}"
               th:alt="${mix.title}"
               onerror="this.src='https://via.placeholder.com/300x300?text=Mix'">
          <div class="card-title" th:text="${mix.title}">Mix Title</div>
          <div class="card-subtitle" th:text="${mix.description}">Mix Description</div>
        </div>
      </div>
    </section>
  </div>

  <th:block layout:fragment="scripts">
    <audio id="global-player" style="display:none;"></audio>
    <script>
      let currentPlayingButton = null;

      function playTrack(button) {
        const previewUrl = button.getAttribute('data-preview');
        const spotifyId = button.getAttribute('data-spotify-id');
        const trackName = button.getAttribute('data-track-name');

        console.log('=== Track Play Clicked ===');
        console.log('Track Name:', trackName);
        console.log('Preview URL:', previewUrl);
        console.log('Spotify ID:', spotifyId);

        // ë¯¸ë¦¬ë“£ê¸° URLì´ ì—†ìœ¼ë©´ Spotifyë¡œ ì´ë™
        if (!previewUrl || previewUrl === '' || previewUrl === 'null') {
          console.log('No preview available, opening Spotify...');
          if (spotifyId && spotifyId !== 'null' && spotifyId !== '') {
            window.open('https://open.spotify.com/track/' + spotifyId, '_blank');
          } else {
            alert('ì´ ê³¡ì€ ë¯¸ë¦¬ë“£ê¸°ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          }
          return;
        }

        // ë¯¸ë¦¬ë“£ê¸° URLì´ ìˆìœ¼ë©´ ì¬ìƒ
        console.log('Playing preview...');
        const player = document.getElementById('global-player');

        // ê°™ì€ ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš°
        if (currentPlayingButton === button) {
          if (!player.paused) {
            console.log('Pausing...');
            player.pause();
            button.style.background = '#1DB954';
            button.innerHTML = '';
            currentPlayingButton = null;
          } else {
            console.log('Resuming...');
            player.play().catch(err => {
              console.error('Play failed:', err);
              alert('ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
            button.style.background = '#1ed760';
            button.innerHTML = 'â¸';
          }
        } else {
          // ë‹¤ë¥¸ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
          console.log('Playing new track...');
          if (currentPlayingButton) {
            currentPlayingButton.style.background = '#1DB954';
            currentPlayingButton.innerHTML = '';
          }

          player.src = previewUrl;
          player.play().then(() => {
            console.log('Playback started successfully');
            button.style.background = '#1ed760';
            button.innerHTML = 'â¸';
            currentPlayingButton = button;
          }).catch(err => {
            console.error('Play failed:', err);
            alert('ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
        }

        // ì¬ìƒ ì¢…ë£Œ ì‹œ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
        player.onended = function() {
          console.log('Playback ended');
          if (currentPlayingButton) {
            currentPlayingButton.style.background = '#1DB954';
            currentPlayingButton.innerHTML = '';
            currentPlayingButton = null;
          }
        };

        // ì—ëŸ¬ í•¸ë“¤ëŸ¬
        player.onerror = function(e) {
          console.error('Player error:', e);
          alert('ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          if (currentPlayingButton) {
            currentPlayingButton.style.background = '#1DB954';
            currentPlayingButton.innerHTML = '';
            currentPlayingButton = null;
          }
        };
      }
    </script>
  </th:block>
</body>
</html>


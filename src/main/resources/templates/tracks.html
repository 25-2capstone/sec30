<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
  <title>ìŒì•… ê²€ìƒ‰ - Sec30 Music</title>
</head>
<body>
  <div layout:fragment="content">
    <!-- ê²€ìƒ‰ ê²°ê³¼ í—¤ë” -->
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title" th:text="${searchQuery != null and !searchQuery.isEmpty()} ? 'ê²€ìƒ‰ ê²°ê³¼: ' + ${searchQuery} : 'ì¸ê¸° íŠ¸ë™'">
          ì¸ê¸° íŠ¸ë™
        </h2>
        <div style="color: var(--muted); font-size: 14px;" th:if="${trackCount != null}">
          <span th:text="${trackCount} + 'ê°œì˜ íŠ¸ë™'">0ê°œì˜ íŠ¸ë™</span>
          <span th:if="${tracksWithPreviewCount != null}"
                style="margin-left: 12px; color: #1DB954;"
                th:text="'(ë¯¸ë¦¬ë“£ê¸° ê°€ëŠ¥: ' + ${tracksWithPreviewCount} + 'ê°œ)'">
          </span>
        </div>
      </div>

      <!-- íŠ¸ë™ ê·¸ë¦¬ë“œ -->
      <div class="track-grid" th:if="${tracks != null and !tracks.isEmpty()}">
        <div class="track-card" th:each="track, iterStat : ${tracks}"
             th:attr="data-track-id=${track.trackId},
                      data-track-name=${track.trackTitle},
                      data-artist=${track.artistName},
                      data-album=${track.albumName},
                      data-image=${track.imageUri},
                      data-preview=${track.previewUrl}"
             onclick="playTrackDirectly(this)"
             style="cursor: pointer;">
          <div class="track-card-image">
            <img th:src="${track.imageUri}"
                 th:alt="${track.trackTitle}"
                 onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
            <button class="track-card-play"
                    onclick="event.stopPropagation(); playTrackDirectly(this.parentElement.parentElement)"></button>
          </div>
          <div class="track-card-title" th:text="${track.trackTitle}">Track Name</div>
          <div class="track-card-artist" th:text="${track.artistName}">Artist</div>
          <div style="color: var(--muted); font-size: 12px; margin-top: 4px;" th:text="${track.albumName}">Album</div>
        </div>
      </div>

      <!-- ë¹ˆ ìƒíƒœ -->
      <div class="empty-state" th:if="${tracks == null or tracks.isEmpty()}">
        <div class="empty-state-icon">ğŸ”</div>
        <div class="empty-state-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-state-desc" th:if="${searchQuery != null and !searchQuery.isEmpty()}">
          "<span th:text="${searchQuery}"></span>"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div class="empty-state-desc" th:if="${searchQuery == null or searchQuery.isEmpty()}">
          ìŒì•…ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”
        </div>
      </div>
    </section>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div th:if="${error}" style="text-align: center; padding: 32px; background: rgba(255,0,0,0.1); border-radius: 12px; margin-top: 24px;">
      <p style="color: #ff6b6b; font-size: 16px;" th:text="${error}">ì˜¤ë¥˜ ë©”ì‹œì§€</p>
    </div>
  </div>

  <th:block layout:fragment="scripts">
    <script>
      function playTrackDirectly(element) {
        console.log('=== playTrackDirectly called ===');
        console.log('Element:', element);

        const trackData = {
          trackId: element.getAttribute('data-track-id'),
          name: element.getAttribute('data-track-name'),
          artist: element.getAttribute('data-artist'),
          album: element.getAttribute('data-album'),
          albumImage: element.getAttribute('data-image'),
          imageUri: element.getAttribute('data-image'),
          previewUrl: element.getAttribute('data-preview'),
          spotifyId: element.getAttribute('data-track-id')
        };

        console.log('Track data extracted:', trackData);
        console.log('Preview URL:', trackData.previewUrl);
        console.log('Preview URL type:', typeof trackData.previewUrl);
        console.log('Preview URL length:', trackData.previewUrl ? trackData.previewUrl.length : 0);

        // ëª¨ë“  íŠ¸ë™ ì¹´ë“œ ìˆ˜ì§‘
        const allTrackCards = document.querySelectorAll('.track-card');
        const allTracksData = Array.from(allTrackCards).map(card => ({
          trackId: card.getAttribute('data-track-id'),
          name: card.getAttribute('data-track-name'),
          artist: card.getAttribute('data-artist'),
          album: card.getAttribute('data-album'),
          albumImage: card.getAttribute('data-image'),
          imageUri: card.getAttribute('data-image'),
          previewUrl: card.getAttribute('data-preview'),
          spotifyId: card.getAttribute('data-track-id')
        }));

        console.log('Total tracks in playlist:', allTracksData.length);

        if (typeof musicPlayer !== 'undefined') {
          musicPlayer.playTrack(trackData, allTracksData);
        } else {
          console.error('musicPlayer not found!');
        }
      }
    </script>
  </th:block>
</body>
</html>


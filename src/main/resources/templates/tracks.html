<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
  <title>ìŒì•… ê²€ìƒ‰ - Sec30 Music</title>
</head>
<body>
  <div layout:fragment="content">
    <!-- ê²€ìƒ‰ ê²°ê³¼ í—¤ë” -->
    <section class="home-section">
      <div class="section-header">
        <h2 class="section-title" th:text="${searchQuery != null and !searchQuery.isEmpty()} ? 'ê²€ìƒ‰ ê²°ê³¼: ' + ${searchQuery} : 'ì¸ê¸° íŠ¸ë™'">
          ì¸ê¸° íŠ¸ë™
        </h2>
        <div style="color: var(--muted); font-size: 14px;" th:if="${trackCount != null}">
          <span th:text="${trackCount} + 'ê°œì˜ íŠ¸ë™'">0ê°œì˜ íŠ¸ë™</span>
        </div>
      </div>

      <!-- íŠ¸ë™ ê·¸ë¦¬ë“œ -->
      <div class="track-grid" th:if="${tracks != null and !tracks.isEmpty()}">
        <div class="track-card" th:each="track : ${tracks}">
          <div class="track-card-image">
            <img th:src="${track.albumImage}"
                 th:alt="${track.name}"
                 onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
            <button class="track-card-play"
                    th:attr="data-preview=${track.previewUrl != null ? track.previewUrl : ''},
                             data-spotify-id=${track.spotifyId},
                             data-track-name=${track.name}"
                    onclick="playTrack(this)"></button>
          </div>
          <div class="track-card-title" th:text="${track.name}">Track Name</div>
          <div class="track-card-artist" th:text="${track.artist}">Artist</div>
          <div style="color: var(--muted); font-size: 12px; margin-top: 4px;" th:text="${track.album}">Album</div>
        </div>
      </div>

      <!-- ë¹ˆ ìƒíƒœ -->
      <div class="empty-state" th:if="${tracks == null or tracks.isEmpty()}">
        <div class="empty-state-icon">ğŸ”</div>
        <div class="empty-state-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-state-desc" th:if="${searchQuery != null and !searchQuery.isEmpty()}">
          "<span th:text="${searchQuery}"></span>"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div class="empty-state-desc" th:if="${searchQuery == null or searchQuery.isEmpty()}">
          ìŒì•…ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”
        </div>
      </div>
    </section>

    <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
    <div th:if="${error}" style="text-align: center; padding: 32px; background: rgba(255,0,0,0.1); border-radius: 12px; margin-top: 24px;">
      <p style="color: #ff6b6b; font-size: 16px;" th:text="${error}">ì˜¤ë¥˜ ë©”ì‹œì§€</p>
    </div>
  </div>

  <th:block layout:fragment="scripts">
    <audio id="global-player" style="display:none;"></audio>
    <script>
      let currentPlayingButton = null;

      function playTrack(button) {
        const previewUrl = button.getAttribute('data-preview');
        const spotifyId = button.getAttribute('data-spotify-id');
        const trackName = button.getAttribute('data-track-name');

        console.log('=== Track Play Clicked ===');
        console.log('Track Name:', trackName);
        console.log('Preview URL:', previewUrl);
        console.log('Spotify ID:', spotifyId);
        console.log('Preview URL is empty?', !previewUrl || previewUrl === '' || previewUrl === 'null');

        // ë¯¸ë¦¬ë“£ê¸° URLì´ ì—†ìœ¼ë©´ Spotifyë¡œ ì´ë™
        if (!previewUrl || previewUrl === '' || previewUrl === 'null') {
          console.log('No preview available, opening Spotify...');
          if (spotifyId && spotifyId !== 'null' && spotifyId !== '') {
            window.open('https://open.spotify.com/track/' + spotifyId, '_blank');
          } else {
            alert('ì´ ê³¡ì€ ë¯¸ë¦¬ë“£ê¸°ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          }
          return;
        }

        // ë¯¸ë¦¬ë“£ê¸° URLì´ ìˆìœ¼ë©´ ì¬ìƒ
        console.log('Playing preview...');
        const player = document.getElementById('global-player');

        // ê°™ì€ ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•œ ê²½ìš°
        if (currentPlayingButton === button) {
          if (!player.paused) {
            console.log('Pausing...');
            player.pause();
            button.style.background = '#1DB954';
            button.innerHTML = '';
            currentPlayingButton = null;
          } else {
            console.log('Resuming...');
            player.play().catch(err => {
              console.error('Play failed:', err);
              alert('ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
            button.style.background = '#1ed760';
            button.innerHTML = 'â¸';
          }
        } else {
          // ë‹¤ë¥¸ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°
          console.log('Playing new track...');
          if (currentPlayingButton) {
            currentPlayingButton.style.background = '#1DB954';
            currentPlayingButton.innerHTML = '';
          }

          player.src = previewUrl;
          player.play().then(() => {
            console.log('Playback started successfully');
            button.style.background = '#1ed760';
            button.innerHTML = 'â¸';
            currentPlayingButton = button;
          }).catch(err => {
            console.error('Play failed:', err);
            alert('ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
        }

        // ì¬ìƒ ì¢…ë£Œ ì‹œ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
        player.onended = function() {
          console.log('Playback ended');
          if (currentPlayingButton) {
            currentPlayingButton.style.background = '#1DB954';
            currentPlayingButton.innerHTML = '';
            currentPlayingButton = null;
          }
        };

        // ì—ëŸ¬ í•¸ë“¤ëŸ¬
        player.onerror = function(e) {
          console.error('Player error:', e);
          alert('ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          if (currentPlayingButton) {
            currentPlayingButton.style.background = '#1DB954';
            currentPlayingButton.innerHTML = '';
            currentPlayingButton = null;
          }
        };
      }
    </script>
  </th:block>
</body>
</html>


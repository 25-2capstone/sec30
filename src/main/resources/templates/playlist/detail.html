<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/base}">
<head>
  <title>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„¸ - Sec30 Music</title>
</head>
<body>
  <div layout:fragment="content">
    <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ í—¤ë” -->
    <section class="playlist-header" th:if="${playlist != null}">
      <div class="playlist-cover">
        <img th:src="${playlist.coverImage}"
             th:alt="${playlist.name}"
             onerror="this.src='https://via.placeholder.com/300x300?text=Playlist'">
      </div>
      <div class="playlist-meta">
        <div class="playlist-type">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</div>
        <h1 th:text="${playlist.name}">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì œëª©</h1>
        <p class="playlist-description" th:text="${playlist.description}">ì„¤ëª…</p>
        <div class="playlist-info">
          <span th:text="${playlist.ownerName}">Owner</span>
          <span class="playlist-info-dot"></span>
          <span th:text="${playlist.trackCount} + 'ê³¡'">0ê³¡</span>
          <span class="playlist-info-dot"></span>
          <span th:text="${playlist.likeCount} + 'ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤'">0ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤</span>
        </div>
      </div>
    </section>

    <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì•¡ì…˜ -->
    <section class="playlist-actions" th:if="${playlist != null}">
      <button class="btn-play-large"></button>
      <button class="btn-icon"
              sec:authorize="isAuthenticated()"
              th:attr="data-playlist-id=${playlist.id}"
              onclick="toggleLike(this)">
        <span th:text="${isLiked ? 'â¤ï¸' : 'ğŸ¤'}">ğŸ¤</span>
      </button>
    </section>

    <!-- íŠ¸ë™ ë¦¬ìŠ¤íŠ¸ -->
    <section class="playlist-tracks" th:if="${tracks != null and !tracks.isEmpty()}">
      <div class="playlist-tracks-header">
        <div>#</div>
        <div>ì œëª©</div>
        <div>ì•¨ë²”</div>
        <div>ì¶”ê°€ëœ ë‚ ì§œ</div>
        <div></div>
      </div>

      <div class="playlist-track" th:each="track, iterStat : ${tracks}">
        <div class="track-number" th:text="${iterStat.index + 1}">1</div>
        <div class="track-title-cell">
          <img th:src="${track.albumImage}"
               th:alt="${track.name}"
               onerror="this.src='https://via.placeholder.com/48x48?text=Track'">
          <div class="track-title-info">
            <div class="track-title-name" th:text="${track.name}">Track Name</div>
            <div class="track-title-artist" th:text="${track.artist}">Artist</div>
          </div>
        </div>
        <div class="track-album" th:text="${track.album}">Album</div>
        <div class="track-date" th:text="${track.addedAt}">Date</div>
        <div class="track-actions">
          <audio controls
                 th:if="${track.previewUrl != null}"
                 th:src="${track.previewUrl}">
          </audio>
        </div>
      </div>
    </section>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <section class="comments-section" sec:authorize="isAuthenticated()" style="margin-top: 48px; padding: 0 32px;">
      <h3 style="font-size: 24px; margin-bottom: 24px;">ëŒ“ê¸€</h3>

      <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
      <form id="commentForm" style="margin-bottom: 32px;">
        <textarea id="commentContent" name="content"
                  placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                  style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); min-height: 80px; resize: vertical;"
                  required></textarea>
        <button type="submit" class="btn btn-primary" style="margin-top: 12px;">ëŒ“ê¸€ ì‘ì„±</button>
      </form>

      <!-- ëŒ“ê¸€ ëª©ë¡ -->
      <div class="comments-list" th:if="${comments != null and !comments.isEmpty()}">
        <div th:each="comment : ${comments}"
             style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600;" th:text="${comment.username}">User</span>
            <span style="color: var(--muted); font-size: 12px;" th:text="${comment.createdAt}">Date</span>
          </div>
          <p style="color: var(--text); line-height: 1.6;" th:text="${comment.content}">Comment content</p>
        </div>
      </div>
    </section>

    <div class="empty-state" th:if="${playlist == null}">
      <div class="empty-state-icon">âŒ</div>
      <div class="empty-state-title">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
    </div>
  </div>

  <th:block layout:fragment="scripts">
    <script th:inline="javascript">
      const playlistId = /*[[${playlist?.id}]]*/ null;

      // ì¢‹ì•„ìš” í† ê¸€
      function toggleLike(button) {
        const id = button.getAttribute('data-playlist-id') || playlistId;
        if (!id) return;

        fetch(`/playlists/${id}/like`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (response.ok) {
            // ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
            return fetch(`/playlists/${id}/like/status`);
          }
        })
        .then(response => response.json())
        .then(isLiked => {
          if (isLiked) {
            button.innerHTML = '<span>â¤ï¸</span>';
          } else {
            button.innerHTML = '<span>ğŸ¤</span>';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      }

      // ëŒ“ê¸€ ì‘ì„±
      document.addEventListener('DOMContentLoaded', function() {
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
          commentForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const content = document.getElementById('commentContent').value;
            if (!content.trim()) {
              alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              return;
            }

            fetch(`/playlists/${playlistId}/comments`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ content: content })
            })
            .then(response => {
              if (response.ok) {
                alert('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
              } else {
                alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
          });
        }
      });

      // ëŒ“ê¸€ ì‚­ì œ
      function deleteComment(commentId) {
        if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        fetch(`/comments/${commentId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (response.ok) {
            alert('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.reload();
          } else {
            alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      }
    </script>
  </th:block>
</body>
</html>

